generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model QuizResponse {
  id          String   @id @default(cuid())
  email       String
  answers     Json
  birthDate   Json
  birthPlace  String?
  birthTime   String?
  firstName   String?
  lastName    String?
  gender      String?
  createdAt   DateTime @default(now())
  coverDesign String?
  session_id  String?
  userId      Int?
  user        User?    @relation(fields: [userId], references: [id])

  @@index([session_id])
  @@index([userId])
}

model User {
  id                       Int                        @id @default(autoincrement())
  email                    String                     @unique
  name                     String?
  createdAt                DateTime                   @default(now())
  deletedAt                DateTime?
  deletionRequestedAt      DateTime?
  chartImages              ChartImage[]
  NatalChartInterpretation NatalChartInterpretation[]
  quizResponses            QuizResponse[]
  appEntitlement           AppEntitlement?
  dataExportRequests       DataExportRequest[]
  deletionRequests         DeletionRequest[]
  consents                 Consent[]
}

model AppEntitlement {
  id            String   @id @default(cuid())
  userId        Int      @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  email         String
  plan          String   @default("trial") // "trial" | "active" | "canceled" | "expired"
  freeUntil     DateTime
  hasReport     Boolean  @default(false)
  purchaseDate  DateTime?
  shopifyOrderId String?
  stripeCustomerId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([email])
  @@index([plan])
  @@index([freeUntil])
}

model ChartImage {
  id                       String                     @id @default(cuid())
  userId                   Int?
  imageUrl                 String
  birthData                Json
  chartType                String?
  createdAt                DateTime                   @default(now())
  email                    String?
  session_id               String?
  user                     User?                      @relation(fields: [userId], references: [id])
  NatalChartInterpretation NatalChartInterpretation[]
}

model NatalChartInterpretation {
  id                     String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                 Int?
  chartImageId           String?
  session_id             String?
  planets                Json?
  houses                 Json?
  ascendant              Float?
  midheaven              Float?
  vertex                 Float?
  lilith                 Json?
  aspects                Json?
  moon_phase_name        String?
  moon_phase_description String?
  hemisphere_east_west   String?
  hemisphere_north_south String?
  elements               Json?
  elements_description   String?
  modes                  Json?
  modes_description      String?
  dominant_sign          Json?
  created_at             DateTime?   @default(now()) @db.Timestamptz(6)
  sun_sign               String?
  moon_sign              String?
  ChartImage             ChartImage? @relation(fields: [chartImageId], references: [id], onUpdate: NoAction)
  User                   User?       @relation(fields: [userId], references: [id], onUpdate: NoAction)

  @@index([chartImageId])
  @@index([userId])
}

model AdminAuditLog {
  id        String   @id @default(cuid())
  adminId   String?  // Admin identifier (email or session ID)
  action    String   // "login", "login_failed", "data_access", "data_modify", "logout", etc.
  resource  String?  // What resource was accessed (e.g., "/api/admin/companion-stats")
  ipAddress String?
  userAgent String?
  success   Boolean
  details   Json?    // Additional context
  createdAt DateTime @default(now())
  
  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@index([success])
}

model DataExportRequest {
  id        String   @id @default(cuid())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  format    String   // "json" | "csv"
  status    String   @default("pending") // "pending" | "processing" | "completed" | "failed"
  fileUrl   String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([status])
  @@index([expiresAt])
}

model DeletionRequest {
  id            String   @id @default(cuid())
  userId        Int
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reason        String?
  status        String   @default("pending") // "pending" | "processing" | "completed" | "failed"
  scheduledAt   DateTime
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([status])
  @@index([scheduledAt])
}

model Consent {
  id            String   @id @default(cuid())
  userId        Int?
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId     String?  // For anonymous users
  consentType   String   // "cookies", "marketing", "analytics"
  granted       Boolean
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
  @@index([sessionId])
  @@index([consentType])
  @@index([granted])
}
