generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AdminAuditLog {
  id        String   @id @default(uuid())
  adminId   String?
  action    String
  resource  String?
  ipAddress String?
  userAgent String?
  success   Boolean
  details   Json?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([adminId])
  @@index([createdAt])
  @@index([success])
}

model AdminRecoveryCode {
  id        String    @id @default(uuid())
  code      String    @unique
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([used])
}

model AppEntitlement {
  id               String    @id
  userId           Int       @unique
  email            String
  plan             String    @default("trial")
  freeUntil        DateTime
  hasReport        Boolean   @default(false)
  purchaseDate     DateTime?
  shopifyOrderId   String?
  stripeCustomerId String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime
  User             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([freeUntil])
  @@index([plan])
}

model ChartImage {
  id         String   @id
  userId     Int?
  imageUrl   String
  birthData  Json
  chartType  String?
  createdAt  DateTime @default(now())
  email      String?
  session_id String?
  User       User?    @relation(fields: [userId], references: [id])
}

model Consent {
  id          String   @id
  userId      Int?
  sessionId   String?
  consentType String
  granted     Boolean
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([consentType])
  @@index([granted])
  @@index([sessionId])
  @@index([userId])
}

model DataExportRequest {
  id        String   @id
  userId    Int
  format    String
  status    String   @default("pending")
  fileUrl   String?
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([expiresAt])
  @@index([status])
  @@index([userId])
}

model DeletionRequest {
  id          String    @id
  userId      Int
  reason      String?
  status      String    @default("pending")
  scheduledAt DateTime
  completedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([scheduledAt])
  @@index([status])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model NatalChartInterpretation {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                 Int?
  chartImageId           String?
  session_id             String?
  planets                Json?
  houses                 Json?
  ascendant              Float?
  midheaven              Float?
  vertex                 Float?
  lilith                 Json?
  aspects                Json?
  moon_phase_name        String?
  moon_phase_description String?
  hemisphere_east_west   String?
  hemisphere_north_south String?
  elements               Json?
  elements_description   String?
  modes                  Json?
  modes_description      String?
  dominant_sign          Json?
  created_at             DateTime? @default(now()) @db.Timestamptz(6)
  sun_sign               String?
  moon_sign              String?

  @@index([chartImageId])
  @@index([userId])
}

model QuizResponse {
  id          String   @id @default(cuid())
  email       String
  answers     Json
  birthDate   Json
  birthPlace  String?
  birthTime   String?
  firstName   String?
  lastName    String?
  gender      String?
  createdAt   DateTime @default(now())
  coverDesign String?
  session_id  String?
  userId      Int?
  User        User?    @relation(fields: [userId], references: [id])

  @@index([session_id])
  @@index([userId])
}

model User {
  id                  Int             @id @default(autoincrement())
  email               String          @unique
  name                String?
  createdAt           DateTime        @default(now())
  deletedAt           DateTime?
  deletionRequestedAt DateTime?
  AppEntitlement      AppEntitlement?
  ChartImage          ChartImage[]
  QuizResponse        QuizResponse[]
}
